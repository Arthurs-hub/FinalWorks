<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–í—Ö–æ–¥ –≤ Cloud Storage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }

        .login-container {
            max-width: 450px;
            margin: 80px auto;
            padding: 32px 28px 28px 28px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            transition: max-width 0.3s;
        }

        .login-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .login-logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }

        .d-none {
            display: none !important;
        }

        .login-container.wide {
            max-width: 700px;
        }
    </style>
</head>

<body>
    <div class="login-container">
        <div class="login-header">
            <img alt="Cloud Logo" class="login-logo" src="CloudIcon.png">
            <h3 class="mb-0">–í—Ö–æ–¥ –≤ Cloud Storage</h3>
        </div>

        <form id="loginForm">
            <div class="mb-3">
                <label class="form-label" for="email">Email:</label>
                <input autofocus class="form-control" id="email" name="email" required type="email">
            </div>
            <div class="mb-3">
                <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å:</label>
                <input class="form-control" id="password" name="password" required type="password">
            </div>
            <button class="btn btn-primary w-100" type="submit">–í–æ–π—Ç–∏</button>
            <div class="text-center mt-3">
                <a href="#" id="showRegister">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                <a href="#" id="showForgot">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
            </div>
        </form>

        <form class="d-none" id="registerForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è:</label>
                        <input class="form-control" id="reg_firstname" required type="text">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ:</label>
                        <input class="form-control" id="reg_middlename" type="text">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–§–∞–º–∏–ª–∏—è:</label>
                        <input class="form-control" id="reg_lastname" required type="text">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–ª:</label>
                        <select class="form-select" id="reg_gender" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">–í–æ–∑—Ä–∞—Å—Ç:</label>
                        <input class="form-control" id="reg_age" max="120" min="1" required type="number">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email:</label>
                        <input class="form-control" id="reg_email" required type="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                        <input class="form-control" id="reg_password" required type="password">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å:</label>
                        <input class="form-control" id="reg_password2" required type="password">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mx-auto">
                    <button class="btn btn-success w-100" type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="#" id="showLogin1">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
            </div>
        </form>

        <form class="d-none" id="resetForm">
            <div class="mb-3">
                <label class="form-label">Email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:</label>
                <input class="form-control" id="reset_email" required type="email">
            </div>
            <button class="btn btn-warning w-100" type="submit">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            <div class="text-center mt-3">
                <a href="#" id="showLogin2">–í–æ–π—Ç–∏</a>
            </div>
        </form>
        <div class="alert mt-3 d-none" id="formMsg"></div>
    </div>
    <script>
        const container = document.querySelector('.login-container');

        function toggleForms(show, hide1, hide2) {
            if (document.getElementById(show) && document.getElementById(hide1) && document.getElementById(hide2)) {
                document.getElementById(show).classList.remove('d-none');
                document.getElementById(hide1).classList.add('d-none');
                document.getElementById(hide2).classList.add('d-none');
            }
            if (container) container.classList.toggle('wide', show === 'registerForm');
        }

        document.getElementById('showRegister').onclick = (e) => {
            e.preventDefault();
            toggleForms('registerForm', 'loginForm', 'resetForm');
        };
        document.getElementById('showLogin1').onclick = document.getElementById('showLogin2').onclick = (e) => {
            e.preventDefault();
            toggleForms('loginForm', 'registerForm', 'resetForm');
        };
        document.getElementById('showForgot').onclick = (e) => {
            e.preventDefault();
            toggleForms('resetForm', 'loginForm', 'registerForm');
        };

        async function handleFormSubmit(formId, url, body) {

            const msg = document.getElementById('formMsg');
            msg.classList.add('d-none');

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                if (!res.ok) {
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', res.status, res.statusText);
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }

                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    msg.textContent = "–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.";
                    msg.className = "alert alert-danger mt-3";
                    msg.classList.remove("d-none");
                    return;
                }

                const data = await res.json();

                if (data.success) {

                    if (formId === 'resetForm' && data.temp_password) {
                        msg.innerHTML = `
                            <div class="mb-3">
                                <strong>‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω!</strong>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–í–∞—à –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-center fw-bold" 
                                           value="${data.temp_password}" 
                                           id="tempPasswordField" readonly
                                           style="font-size: 1.2em; letter-spacing: 2px; background: #f8f9fa;">
                                    <button class="btn btn-outline-primary" type="button" 
                                            onclick="copyTempPassword()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-success w-100" onclick="goToLogin()">
                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—Ö–æ–¥—É
                                </button>
                            </div>
                            <small class="text-muted">
                                üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.<br>
                                –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞.
                            </small>
                        `;
                        msg.className = "alert alert-success mt-3";
                        msg.classList.remove("d-none");
                        return;
                    } else {
                        msg.textContent = formId === 'registerForm' ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!" : "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!";
                        msg.className = "alert alert-success mt-3";
                        msg.classList.remove("d-none");

                        setTimeout(() => {
                            if (formId === 'registerForm') {
                                document.getElementById('showLogin1').click();
                            } else {
                                window.location.href = data.role === 'admin' ? '/CloudStorageApp/public/Admin.html' : '/CloudStorageApp/public/upload.html';
                            }
                        }, 3000);
                    }
                } else {
                    msg.textContent = data.error || "–û—à–∏–±–∫–∞!";
                    msg.className = "alert alert-danger mt-3";
                    msg.classList.remove("d-none");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
                msg.textContent = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!";
                msg.className = "alert alert-danger mt-3";
                msg.classList.remove("d-none");
            }

            if (formId !== 'resetForm') {
                setTimeout(() => msg.classList.add("d-none"), 5000);
            }
        }

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            await handleFormSubmit('loginForm', '/CloudStorageApp/public/login', {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            });
        };

        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const password = document.getElementById('reg_password').value;
            const password2 = document.getElementById('reg_password2').value;
            const msg = document.getElementById('formMsg');

            if (password !== password2) {
                msg.textContent = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç";
                msg.className = "alert alert-danger mt-3";
                msg.classList.remove("d-none");
                return setTimeout(() => msg.classList.add("d-none"), 3000);
            }

            const requestData = {
                first_name: document.getElementById('reg_firstname').value,
                middle_name: document.getElementById('reg_middlename').value,
                last_name: document.getElementById('reg_lastname').value,
                gender: document.getElementById('reg_gender').value,
                age: document.getElementById('reg_age').value,
                email: document.getElementById('reg_email').value,
                password
            };


            await handleFormSubmit('registerForm', '/CloudStorageApp/public/register', {
                first_name: document.getElementById('reg_firstname').value,
                middle_name: document.getElementById('reg_middlename').value,
                last_name: document.getElementById('reg_lastname').value,
                gender: document.getElementById('reg_gender').value,
                age: document.getElementById('reg_age').value,
                email: document.getElementById('reg_email').value,
                password
            });
        };

        document.getElementById('resetForm').onsubmit = async (e) => {
            e.preventDefault();
            await handleFormSubmit('resetForm', '/CloudStorageApp/public/password-reset-public', {
                email: document.getElementById('reset_email').value
            });
        };


        function copyTempPassword() {
            const field = document.getElementById('tempPasswordField');
            if (!field) return;

            field.select();
            field.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');

                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-primary');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            }
        }

        function goToLogin() {
            document.getElementById('showLogin1').click();

            document.getElementById('reset_email').value = '';
            document.getElementById('formMsg').classList.add('d-none');
        }
    </script>

</body>

</html>