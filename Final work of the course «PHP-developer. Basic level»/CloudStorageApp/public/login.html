<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <title>–í—Ö–æ–¥ –≤ Cloud Storage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/login.css">
</head>

<body>
    <div class="login-container">
        <div class="login-header">
            <img alt="Cloud Logo" class="login-logo" src="CloudIcon.png">
            <h3 class="mb-0">–í—Ö–æ–¥ –≤ Cloud Storage</h3>
        </div>

        <form id="loginForm">
            <div class="form-group">
                <label class="form-label" for="login_email">Email:</label>
                <input autofocus class="form-control" id="login_email" name="email" required type="email"
                    autocomplete="email">
            </div>
            <div class="form-group">
                <label class="form-label" for="login_password">–ü–∞—Ä–æ–ª—å:</label>
                <input class="form-control" id="login_password" name="password" required type="password"
                    autocomplete="current-password">
            </div>
            <button class="btn btn-primary w-100 mt-3" type="submit">–í–æ–π—Ç–∏</button>
            <div class="text-center mt-3">
                <a href="#" id="showRegister">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                <span class="mx-2">|</span>
                <a href="#" id="showForgot">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
            </div>
        </form>

        <form class="d-none" id="registerForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="reg_firstname">–ò–º—è <span class="text-danger">*</span>:</label>
                        <input class="form-control" id="reg_firstname" name="firstname" required type="text"
                            autocomplete="given-name">
                        <div class="invalid-feedback">–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg_middlename">–û—Ç—á–µ—Å—Ç–≤–æ:</label>
                        <input class="form-control" id="reg_middlename" name="middlename" type="text"
                            autocomplete="additional-name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg_lastname">–§–∞–º–∏–ª–∏—è <span class="text-danger">*</span>:</label>
                        <input class="form-control" id="reg_lastname" name="lastname" required type="text"
                            autocomplete="family-name">
                        <div class="invalid-feedback">–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg_gender">–ü–æ–ª:</label>
                        <select class="form-select" id="reg_gender" name="gender" autocomplete="sex">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" for="reg_age">–í–æ–∑—Ä–∞—Å—Ç:</label>
                        <input class="form-control" id="reg_age" name="age" max="120" min="1" type="number"
                            autocomplete="off">
                        <div class="invalid-feedback">–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 120 –ª–µ—Ç</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg_email">Email <span class="text-danger">*</span>:</label>
                        <input class="form-control" id="reg_email" name="email" required type="email"
                            autocomplete="email">
                        <div class="invalid-feedback">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg_password">–ü–∞—Ä–æ–ª—å <span class="text-danger">*</span>:</label>
                        <input class="form-control" id="reg_password" name="password" required type="password"
                            minlength="6" autocomplete="new-password">
                        <div class="invalid-feedback">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</div>
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg_password2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å <span
                                class="text-danger">*</span>:</label>
                        <input class="form-control" id="reg_password2" name="password2" required type="password"
                            minlength="6" autocomplete="new-password">
                        <div class="invalid-feedback">–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6 mx-auto">
                    <button class="btn btn-success w-100" type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="#" id="showLogin1">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
            </div>
        </form>

        <form class="d-none" id="resetForm">
            <div class="form-group">
                <label class="form-label" for="reset_email">Email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è:</label>
                <input class="form-control" id="reset_email" name="reset_email" required type="email"
                    autocomplete="email">
            </div>
            <button class="btn btn-warning w-100 mt-3" type="submit">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            <div class="text-center mt-3">
                <a href="#" id="showLogin2">–í–æ–π—Ç–∏</a>
            </div>
        </form>
        <div class="alert mt-3 d-none" id="formMsg"></div>
    </div>

    <script>
        const container = document.querySelector('.login-container');


        function toggleForms(show, hide1, hide2) {
            if (document.getElementById(show) && document.getElementById(hide1) && document.getElementById(hide2)) {
                document.getElementById(show).classList.remove('d-none');
                document.getElementById(hide1).classList.add('d-none');
                document.getElementById(hide2).classList.add('d-none');
            }
            if (container) container.classList.toggle('wide', show === 'registerForm');
        }

        document.getElementById('showRegister').onclick = (e) => {
            e.preventDefault();
            toggleForms('registerForm', 'loginForm', 'resetForm');
        };
        document.getElementById('showLogin1').onclick = document.getElementById('showLogin2').onclick = (e) => {
            e.preventDefault();
            toggleForms('loginForm', 'registerForm', 'resetForm');
        };
        document.getElementById('showForgot').onclick = (e) => {
            e.preventDefault();
            toggleForms('resetForm', 'loginForm', 'registerForm');
        };


        function autoHideError(element, isInline = false) {
            if (isInline) {
                element.classList.add('auto-hide-inline');
                setTimeout(() => {
                    if (element.parentNode) {
                        element.style.display = 'none';
                        element.classList.remove('auto-hide-inline');
                    }
                }, 3500);
            } else {
                element.classList.add('auto-hide');
                setTimeout(() => {
                    if (element.parentNode) {
                        element.style.display = 'none';
                        element.classList.remove('auto-hide');
                    }
                }, 3500);
            }
        }


        function showInlineError(input, message) {

            const originalPlaceholder = input.getAttribute('placeholder') || '';

            if (!input.hasAttribute('data-original-placeholder')) {
                input.setAttribute('data-original-placeholder', originalPlaceholder);
            }

            input.setAttribute('placeholder', message);
            input.classList.add('has-inline-error');

            setTimeout(() => {
                if (input.classList.contains('has-inline-error')) {
                    input.setAttribute('placeholder', input.getAttribute('data-original-placeholder') || '');
                    input.classList.remove('has-inline-error');
                }
            }, 3000);

            const focusHandler = () => {
                input.setAttribute('placeholder', input.getAttribute('data-original-placeholder') || '');
                input.classList.remove('has-inline-error');
                input.removeEventListener('focus', focusHandler);
            };
            input.addEventListener('focus', focusHandler);
        }


        function shouldUseInlineError(input, message) {

            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.fontSize = window.getComputedStyle(input).fontSize;
            tempSpan.style.fontFamily = window.getComputedStyle(input).fontFamily;
            tempSpan.textContent = message;
            document.body.appendChild(tempSpan);

            const messageWidth = tempSpan.offsetWidth;
            const inputWidth = input.offsetWidth - 60;

            document.body.removeChild(tempSpan);

            return messageWidth <= inputWidth;
        }

        document.addEventListener('DOMContentLoaded', function () {

            const firstNameInput = document.getElementById('reg_firstname');
            if (firstNameInput) {
                firstNameInput.addEventListener('blur', validateRequired);
                firstNameInput.addEventListener('input', clearInvalidOnInput);
            }

            const lastNameInput = document.getElementById('reg_lastname');
            if (lastNameInput) {
                lastNameInput.addEventListener('blur', validateRequired);
                lastNameInput.addEventListener('input', clearInvalidOnInput);
            }

            const emailInput = document.getElementById('reg_email');
            if (emailInput) {
                emailInput.addEventListener('blur', validateEmail);
                emailInput.addEventListener('input', clearInvalidOnInput);
            }

            const ageInput = document.getElementById('reg_age');
            if (ageInput) {
                ageInput.addEventListener('blur', validateAge);
                ageInput.addEventListener('input', clearInvalidOnInput);
            }

            const passwordInput = document.getElementById('reg_password');
            if (passwordInput) {
                passwordInput.addEventListener('input', validatePassword);
                passwordInput.addEventListener('blur', validatePassword);
            }

            const password2Input = document.getElementById('reg_password2');
            if (password2Input) {
                password2Input.addEventListener('input', validatePasswordMatch);
                password2Input.addEventListener('blur', validatePasswordMatch);
            }
        });


        function validateRequired() {
            const errorElement = this.parentNode.querySelector('.invalid-feedback');
            const errorMessage = '–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';

            if (this.value.trim() === '') {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, errorMessage)) {
                    showInlineError(this, errorMessage);
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                return false;
            } else {
                this.classList.remove('is-invalid', 'has-inline-error');
                this.classList.add('is-valid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                return true;
            }
        }


        function validateEmail() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const errorElement = this.parentNode.querySelector('.invalid-feedback');
            let errorMessage = '';

            if (this.value.trim() === '') {
                errorMessage = 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';
            } else if (!emailRegex.test(this.value)) {
                errorMessage = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
            }

            if (errorMessage) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, errorMessage)) {
                    showInlineError(this, errorMessage);
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                return false;
            } else {
                this.classList.remove('is-invalid', 'has-inline-error');
                this.classList.add('is-valid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                return true;
            }
        }


        function validateAge() {
            const age = parseInt(this.value);
            const errorElement = this.parentNode.querySelector('.invalid-feedback');
            const errorMessage = '–í–æ–∑—Ä–∞—Å—Ç: 1-120 –ª–µ—Ç';

            if (this.value && (isNaN(age) || age < 1 || age > 120)) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, errorMessage)) {
                    showInlineError(this, errorMessage);
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                return false;
            } else if (this.value) {
                this.classList.remove('is-invalid', 'has-inline-error');
                this.classList.add('is-valid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                return true;
            } else {
                this.classList.remove('is-invalid', 'is-valid', 'has-inline-error');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                return true;
            }
        }


        function validatePassword() {
            const password = this.value;
            const strengthDiv = document.getElementById('passwordStrength');
            const errorElement = this.parentNode.querySelector('.invalid-feedback');
            const errorMessage = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';

            if (password.length === 0) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω')) {
                    showInlineError(this, '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = '–ü–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω';
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                strengthDiv.style.display = 'none';
                return false;
            } else if (password.length < 6) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, errorMessage)) {
                    showInlineError(this, errorMessage);
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                strengthDiv.textContent = '–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø–∞—Ä–æ–ª—å';
                strengthDiv.className = 'password-strength weak';
                strengthDiv.style.display = 'block';
                autoHideError(strengthDiv, true);
                return false;
            } else {
                this.classList.remove('is-invalid', 'has-inline-error');
                this.classList.add('is-valid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }

                let strength = 0;
                if (password.length >= 8) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;

                if (strength <= 2) {
                    strengthDiv.textContent = '–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å';
                    strengthDiv.className = 'password-strength weak';
                } else if (strength <= 3) {
                    strengthDiv.textContent = '–°—Ä–µ–¥–Ω–∏–π –ø–∞—Ä–æ–ª—å';
                    strengthDiv.className = 'password-strength medium';
                } else {
                    strengthDiv.textContent = '–°–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                    strengthDiv.className = 'password-strength strong';
                }
                strengthDiv.style.display = 'block';
                autoHideError(strengthDiv, true);

                const password2Input = document.getElementById('reg_password2');
                if (password2Input && password2Input.value) {
                    validatePasswordMatch.call(password2Input);
                }

                return true;
            }
        }


        function validatePasswordMatch() {
            const password = document.getElementById('reg_password').value;
            const password2 = this.value;
            const errorElement = this.parentNode.querySelector('.invalid-feedback');
            const errorMessage = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';

            if (password2.length === 0) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å')) {
                    showInlineError(this, '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                return false;
            } else if (password2.length < 6) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤')) {
                    showInlineError(this, '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                return false;
            } else if (password !== password2) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');

                if (shouldUseInlineError(this, errorMessage)) {
                    showInlineError(this, errorMessage);
                    if (errorElement) errorElement.style.display = 'none';
                } else {
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.style.display = 'block';
                        autoHideError(errorElement);
                    }
                }
                return false;
            } else {
                this.classList.remove('is-invalid', 'has-inline-error');
                this.classList.add('is-valid');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                return true;
            }
        }


        function clearInvalidOnInput() {
            if (this.classList.contains('is-invalid') && this.value.trim() !== '') {
                this.classList.remove('is-invalid');
                const errorElement = this.parentNode.querySelector('.invalid-feedback');
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            }
            if (this.classList.contains('has-inline-error')) {
                this.classList.remove('has-inline-error');
                this.setAttribute('placeholder', this.getAttribute('data-original-placeholder') || '');
            }
        }


        async function handleFormSubmit(formId, url, body) {
            const msg = document.getElementById('formMsg');
            msg.classList.add('d-none');

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', res.status);

                const responseText = await res.text();
                console.log('–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText);

                if (!res.ok) {

                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                        console.log('–î–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (JSON):', errorData);

                        msg.textContent = errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status} ${res.statusText}`;
                        msg.className = "alert alert-danger mt-3";
                        msg.classList.remove("d-none");
                        return;
                    } catch (parseError) {
                        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç –∫–∞–∫ JSON:', parseError);
                        console.log('–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseText);
                        msg.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${res.status}. ${responseText.substring(0, 200)}`;
                        msg.className = "alert alert-danger mt-3";
                        msg.classList.remove("d-none");
                        return;
                    }
                }

                const contentType = res.headers.get("content-type");
                console.log('Content-Type:', contentType);

                if (!contentType || !contentType.includes("application/json")) {
                    msg.textContent = "–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.";
                    msg.className = "alert alert-danger mt-3";
                    msg.classList.remove("d-none");
                    return;
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:', data);
                } catch (parseError) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–∞—Ä—Å–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç:', parseError);
                    msg.textContent = "–û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.";
                    msg.className = "alert alert-danger mt-3";
                    msg.classList.remove("d-none");
                    return;
                }

                if (data.success) {
                    console.log('Form submission successful', { formId, data });
                    if (formId === 'resetForm' && (data.temp_password || data.password_reset || data.action === 'password_reset')) {
                        console.log('Password reset detected, showing temp password UI');
                        msg.innerHTML = `
                            <div class="mb-3">
                                <strong>‚úÖ –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω!</strong>
                            </div>
                            ${data.temp_password ? `
                            <div class="mb-3">
                                <label class="form-label" for="tempPasswordField">–í–∞—à –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-center fw-bold" 
                                           value="${data.temp_password}" 
                                           id="tempPasswordField" readonly
                                           style="font-size: 1.2em; letter-spacing: 2px; background: #f8f9fa;">
                                    <button class="btn btn-outline-primary" type="button" 
                                            onclick="copyTempPassword()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                </div>
                            </div>` : '<div class="mb-3">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤–∞—à email.</div>'}
                            <div class="mb-3">
                                <button class="btn btn-success w-100" onclick="goToLogin()">
                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—Ö–æ–¥—É
                                </button>
                            </div>
                            <small class="text-muted">
                                üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.<br>
                                –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞.
                            </small>
                        `;
                        msg.className = "alert alert-success mt-3";
                        msg.classList.remove("d-none");
                        return;
                    } else {
                        msg.textContent = formId === 'registerForm' ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!" : "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!";
                        msg.className = "alert alert-success mt-3";
                        msg.classList.remove("d-none");

                        setTimeout(() => {
                            console.log('Redirect logic triggered', { formId, data });
                            if (formId === 'registerForm') {
                                console.log('Redirecting to login form after registration');
                                document.getElementById('showLogin1').click();
                            } else if (formId === 'loginForm') {
                                console.log('Redirecting to upload.html after login');
                              
                                window.location.href = (data.user && (data.user.is_admin === 1 || data.user.role === 'admin'))
                                    ? '/CloudStorageApp/public/Admin.html'
                                    : '/CloudStorageApp/public/upload.html';
                            } else {
                                console.log('Not redirecting for form:', formId);
                            }
                            
                        }, 3000);
                    }
                } else {

                    msg.textContent = data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞!";
                    msg.className = "alert alert-danger mt-3";
                    msg.classList.remove("d-none");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);

                msg.textContent = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`;
                msg.className = "alert alert-danger mt-3";
                msg.classList.remove("d-none");
            }

            if (formId !== 'resetForm') {
                setTimeout(() => msg.classList.add("d-none"), 5000);
            }
        }


        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            await handleFormSubmit('loginForm', '/CloudStorageApp/public/login', {
                email: document.getElementById('login_email').value,
                password: document.getElementById('login_password').value
            });
        };


        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();

            const firstName = document.getElementById('reg_firstname');
            const lastName = document.getElementById('reg_lastname');
            const email = document.getElementById('reg_email');
            const password = document.getElementById('reg_password');
            const password2 = document.getElementById('reg_password2');
            const age = document.getElementById('reg_age');

            let isValid = true;
            if (!validateRequired.call(firstName)) isValid = false;
            if (!validateRequired.call(lastName)) isValid = false;
            if (!validateEmail.call(email)) isValid = false;
            if (!validatePassword.call(password)) isValid = false;
            if (!validatePasswordMatch.call(password2)) isValid = false;
            if (!validateAge.call(age)) isValid = false;

            if (!isValid) {
                const msg = document.getElementById('formMsg');
                msg.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ";
                msg.className = "alert alert-danger mt-3";
                msg.classList.remove("d-none");
                setTimeout(() => msg.classList.add("d-none"), 5000);
                return;
            }

            if (password.value !== password2.value) {
                const msg = document.getElementById('formMsg');
                msg.textContent = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç";
                msg.className = "alert alert-danger mt-3";
                msg.classList.remove("d-none");
                setTimeout(() => msg.classList.add("d-none"), 3000);
                return;
            }

            if (password.value.length < 6) {
                const msg = document.getElementById('formMsg');
                msg.textContent = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤";
                msg.className = "alert alert-danger mt-3";
                msg.classList.remove("d-none");
                setTimeout(() => msg.classList.add("d-none"), 3000);
                return;
            }

            const requestData = {
                first_name: firstName.value.trim(),
                middle_name: document.getElementById('reg_middlename').value.trim() || null,
                last_name: lastName.value.trim(),
                gender: document.getElementById('reg_gender').value || null,
                age: age.value ? parseInt(age.value) : null,
                email: email.value.trim(),
                password: password.value
            };

            await handleFormSubmit('registerForm', '/CloudStorageApp/public/register', requestData);
        };


        document.getElementById('resetForm').onsubmit = async (e) => {
            e.preventDefault();
            await handleFormSubmit('resetForm', '/CloudStorageApp/public/password-reset-public', {
                email: document.getElementById('reset_email').value
            });
        };


        function copyTempPassword() {
            const field = document.getElementById('tempPasswordField');
            if (!field) return;

            field.select();
            field.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');

                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-outline-primary');

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            } catch (err) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.');
            }
        }

        
        function goToLogin() {
            document.getElementById('showLogin1').click();
            document.getElementById('reset_email').value = '';
            document.getElementById('formMsg').classList.add('d-none');
        }
    </script>

</body>

</html>